# Gradient-Based Recourse Revisited {#sec-method}

In the following we first set out a generalized framework for gradient-based counterfactual search in @sec-method-general to introduce the various counterfactual generators we have chosen to use in our experiments. We then describe the experimental setup in @sec-method-2-experiment and introduce several evaluation metrics used to benchmark the different generators.

## From individual recourse ... {#sec-method-general}

In this work we have chosen to focus on a number of gradient-based counterfactual generators to investigate the endogenous dynamics we introduced in @sec-intro. Gradient-based counterfactual search is well-suited for differentiable black-box models like deep neural networks. We can restate @eq-solution in a more general form that encompasses most gradient-based approaches to counterfactual search:

$$
\begin{aligned}
\mathbf{s}^\prime &= \arg \min_{\mathbf{s}^\prime \in \mathcal{S}} \left\{ \sum_{k=1}^{K} {\ell(M(f(s_k^\prime)),t)}+ \lambda {h(f(s_k^\prime)) }  \right\}
\end{aligned}
$$ {#eq-general}

Here $\mathbf{s}^\prime=\left\{s_k^\prime\right\}_K$ is the stacked $K$-dimensional array of counterfactual states  and $f: \mathcal{S} \mapsto \mathcal{X}$ maps from the counterfactual state space to the feature space. 

## ... towards collective recourse

To explicitly address the notion that individual recourse may affect the outcome and prospect of other individuals, we propose to extend @eq-general as follows:

$$
\begin{aligned}
\mathbf{s}^\prime &= \arg \min_{\mathbf{s}^\prime \in \mathcal{S}}  \sum_{k=1}^{K} {\ell(M(f(s_k^\prime)),t)} \\ &+ \lambda_1 {h(f(s_k^\prime)) } + \lambda_2 {g(f(s_k^\prime))}  
\end{aligned}
$$ {#eq-collective}

Here $h(f(s_k^\prime))$ denotes the proxy for private costs faced by the individual as before and $\lambda_1$ governs to what extent that private cost ought to be penalised. The newly introduced term $g(f(s_k^\prime))$ is meant to capture and address social costs incurred by the collective of individuals in response to changes in $\mathbf{s}^\prime$. The trade-off between private and social costs is determined by the ratio between $\lambda_1$ and $\lambda_2$. As with individual recourse, the exact choice of $g(\cdot)$ is not obvious, nor do we intend to provide a definite answer in this work, if such even exists. A straight-forward choice simply extends the baseline approach by @wachter2017counterfactual: instead of only penalizing the distance of the individuals' counterfactual to its factual, we propose penalizing its distance to some sensible point in the target domain, for example the sample average: $\bar{\mathbf{x}}$. For such a recourse objective, higher choices of $\lambda_2$ relative to $\lambda_1$ will lead counterfactuals to gravitate towards the specified point in the target domain. In the remainder of this paper we will therefore refer to this approach as **Gravitational** generator, when we investigate its potential usefulness for mitigating endongenous macrodynamics^[Note that despite the naming convention our goal here is not to provide yet another counterfactual generator, but merely investigate the most simple penalty we can think of with respect to its effectiveness.].

## A note on convergence

For this simple mitigating strategy underlying the Gravitational generator to work as expected, one needs to ensure that counterfactual search continues, even after a predetermined threshold probability $\gamma$ has potentially already been reached. @fig-convergence illustrates this distinction: if one chooses to terminate search once the desired threshold is reached (left panel) the gravitational pull towards $\bar{\mathbf{x}}$ is never actually satisfied (compare to right panel). More generally, if convergence is defined simply in terms of flipping the predicted label with some desired degree of confidence, this corresponds to essentially ignoring any parts of the counterfactual search objective that do not involve $\ell(M(f(s_k^\prime)),t)$ beyond that point. While this may be appropriate for some applications, in general this seems like an odd convention. Since we nonetheless seen convergence specified simply in terms of reaching the threshold probability in some places^[@joshi2019towards define convergence of Algorithm 1 in this way. The implementation of @wachter2017counterfactual in CARLA is also defined in this way.], we thought it worth making this distinction explicit.

![Comparison of counterfactual search outcome with simple (left) and strict convergence (right).](www/gravitational_generator_comparison.png){#fig-convergence fig.pos="h" width=45%}

